Nazwa pliku: wizardlm_random_narrative_feedback.txt
Data: 2025-09-13
Temat: WizardLM + Electron â€“ generateRandomDescription zwraca tagi zamiast opisÃ³w (naprawa promptÃ³w i formatowania)

1) Kontekst i objawy
- Po naprawie stop sequences (uÅ¼ywamy USER: zamiast ASSISTANT:) Random generuje rÃ³Å¼norodne wyniki.
- Nowy problem: model zwraca listy tagÃ³w lub miks tagÃ³w z opisem zamiast czystej prozy.
- PrzykÅ‚ady:
  (Tags: woman, 18s, japanese, curvy build, realistic, amateur, suggestive) â€“ prefiks i nawiasy
  (Woman, 18s, japanese, curvy build, realistic, amateur) â€“ czyste tagi w nawiasach
  Curvy, Realistic, Amateur, Suggestive, Scene: A young woman... â€“ miks tagÃ³w i opisu

2) GÅ‚Ã³wna przyczyna
- Prompty wprost Å¼Ä…dajÄ… â€œcomma-separated tagsâ€ (zarÃ³wno system, jak i user content), wiÄ™c model zgodnie z instrukcjÄ… zwraca tagi.
- Dodatkowo brak â€œformat lockâ€ z przykÅ‚adami (bad/good) uÅ‚atwia modelowi powrÃ³t do trybu tagÃ³w.

3) Odpowiedzi na pytania
1. Czy system prompt powinien prosiÄ‡ o â€œopisy scenâ€ zamiast â€œcomma-separated tagsâ€?
   - Tak. PrzeÅ‚Ä…cz system prompt na â€œcreative visual storytellerâ€ i zakaz list/tagÃ³w; poproÅ› o 2â€“3 zdania prozy.

2. Jak zmodyfikowaÄ‡ user content, Å¼eby LLM generowaÅ‚ narracyjne opisy?
   - PoproÅ› o 1 akapit, 2â€“3 zdania (35â€“80 sÅ‚Ã³w), bez list/etykiet/nawiasÃ³w/quotes.
   - Dodaj anty-przykÅ‚ad (â€œBad: Tags: â€¦â€) i wÅ‚aÅ›ciwy przykÅ‚ad (â€œGood: A young woman â€¦â€).

3. Czy normalizeToTagsLine powinna byÄ‡ uÅ¼ywana dla opisÃ³w?
   - Nie. Zostaw jÄ… do zadaÅ„ w trybie â€œtagiâ€. Dla opisÃ³w dodaj delikatny normalizer prozy: normalizeNarrative.

4. Jak sprawiÄ‡, by LLM nie dodawaÅ‚ prefiksÃ³w â€œTags:â€ ani nawiasÃ³w?
   - Po stronie promptu: zakaz uÅ¼ywania etykiet/nawiasÃ³w.
   - Po stronie postprocessingu: normalizeNarrative usuwa wiodÄ…ce â€œTags: â€¦â€, nawiasowe bloki z tagami, pojedyncze cudzysÅ‚owy itp.

4) Zmiany w kodzie (kopiuj-wklej)

A. Dodaj delikatny normalizer prozy do customApiService.ts
--------------------------------------------------------
/**
 * Minimalne czyszczenie prozy: usuwa role/etykiety/nawiasowe tagi na poczÄ…tku,
 * scala spacje, obcina do 2â€“3 zdaÅ„ i dopina kropkÄ™ jeÅ›li brak.
 */
function normalizeNarrative(text: string): string {
  let s = (text ?? '').toString();

  // UsuÅ„ code fences i pseudo-XML
  s = s.replace(/```[\s\S]*?```/g, ' ').replace(/<[^>]*>/g, ' ');
  s = s.replace(/```math
\/?INST```|<<\/?SYS>>|<\/?SYS>|<\/?SYSTEM>|```math
SYS```|<\/?assistant>|<\/?user>/gi, '');

  // Wytnij wstÄ™pne numerowanie/listy
  s = s.replace(/^\s*KATEX_INLINE_OPEN?\d+KATEX_INLINE_CLOSE?[.)]\s+/, '');

  // JeÅ›li pojawi siÄ™ "Scene:" lub "Description:" â€“ trzymaj to, co po dwukropku
  const sceneIdx = s.search(/\b(scene|description)\s*:/i);
  if (sceneIdx >= 0) {
    s = s.slice(s.indexOf(':', sceneIdx) + 1);
  }

  // UsuÅ„ wiodÄ…ce "Tags: ..." (rÃ³Å¼ne warianty) wraz z ewentualnymi nawiasami
  s = s.replace(/^\s*tags?\s*:\s*[^\n]*KATEX_INLINE_CLOSE\s*[-â€“â€”:]*\s*/i, '');
  s = s.replace(/^\s*tags?\s*:\s*[^\n]*[-â€“â€”:]\s*/i, '');
  s = s.replace(/^\s*tags?\s*:\s*[^\n]*\s*/i, '');

  // UsuÅ„ wiodÄ…cy blok nawiasowy jeÅ›li wyglÄ…da na listÄ™ tagÃ³w (â‰¥2 przecinki)
  s = s.replace(/^\s*KATEX_INLINE_OPEN(?:[^()]*?,){2,}[^()]*KATEX_INLINE_CLOSE\s*[-â€“â€”:]*\s*/, '');

  // UsuÅ„ cudzysÅ‚owy/backticki na brzegach
  s = s.replace(/^["'`]+|["'`]+$/g, '');

  // Zredukuj biaÅ‚e znaki
  s = s.replace(/\r?\n+/g, ' ').replace(/\s{2,}/g, ' ').trim();

  // Zatrzymaj do 2â€“3 pierwszych zdaÅ„ (jeÅ›li model siÄ™ rozgada)
  const sentences = s.split(/(?<=[.!?])\s+/).filter(Boolean);
  if (sentences.length > 3) {
    s = sentences.slice(0, 3).join(' ');
  }

  // Dopnij kropkÄ™ jeÅ›li brak
  if (!/[.!?]"?$/.test(s) && s.length > 0) {
    s += '.';
  }

  return s;
}

B. ZmieÅ„ generateRandomDescription na tryb narracyjny (proza)
-------------------------------------------------------------
- ZastÄ…p dotychczasowe prompty (ktÃ³re prosiÅ‚y o tagi) narracyjnymi.
- UsuÅ„ wywoÅ‚anie normalizeToTagsLine â€“ uÅ¼yj normalizeNarrative.
- Zostaw STOP_SEQS (tylko USER: warianty).

export const generateRandomDescription = async (
  config: CustomApiConfig,
  nsfwSettings: NsfwSettingsState,
  styleFilter: StyleFilter,
  characterSettings: CharacterSettingsState,
  selectedPresets: string[]
): Promise<string> => {
  // System prompt: storyteller (nie tag generator)
  const systemPrompt = `You are a creative visual storyteller.
Write concise, vivid scene descriptions in natural English prose (not tags).
Use concrete visual details: subject, setting, lighting, composition, mood.
Return only the description; no labels, no lists, no parentheses, no quotes.`;

  // Baza elementÃ³w dla inspiracji
  const baseElements: string[] = [];
  if (characterSettings.gender === 'male') baseElements.push('man');
  else if (characterSettings.gender === 'female') baseElements.push('woman');

  if (characterSettings.age && characterSettings.age !== 'any') baseElements.push(`${characterSettings.age}`);
  if (characterSettings.ethnicity && characterSettings.ethnicity !== 'any') baseElements.push(`${characterSettings.ethnicity}`);
  if (characterSettings.bodyType && characterSettings.bodyType !== 'any') baseElements.push(`${characterSettings.bodyType} build`);
  baseElements.push(`${styleFilter.main}`);
  if (styleFilter.sub && styleFilter.sub !== 'any') baseElements.push(`${styleFilter.sub}`);
  if (nsfwSettings.mode === 'nsfw') baseElements.push('suggestive');
  else if (nsfwSettings.mode === 'hardcore') baseElements.push('explicit');
  if (selectedPresets.length > 0) baseElements.push(...selectedPresets);

  const basePrompt = baseElements.join(', ');

  const userContent = [
    `Using these elements: ${basePrompt}.`,
    `Write a single paragraph of 2â€“3 sentences (35â€“80 words), natural English.`,
    `Do NOT output comma-separated tags, lists, labels, headings, or parentheses.`,
    `Start directly with the description. No quotes. Return only the description text.`,
    `Bad: "Tags: woman, curvy, realistic, cinematic lighting"`,
    `Good: "A young woman with a curvy build sits alone on a rustic wooden bench, a suggestive smile playing at the corner of her mouth. Soft, warm light pools across her face and the weathered wood, while the background melts into a gentle blur."`
  ].join(' ');

  const messages = [
    { role: 'system', content: systemPrompt },
    { role: 'user', content: userContent }
  ];

  console.log('ğŸ” DEBUG: generateRandomDescription(narrative) called');
  console.log('ğŸ” DEBUG: Base elements:', baseElements);
  console.log('ğŸ” DEBUG: User content:', userContent);

  try {
    const response = await makeApiCall(config, messages, {
      temperature: 0.8,   // nieco wyÅ¼ej dla Å¼ywszej prozy
      top_p: 0.95,
      maxTokens: 180,
      stop: STOP_SEQS
    });

    console.log('ğŸ” DEBUG: Raw LLM response:', JSON.stringify(response));
    const cleaned = normalizeNarrative(response);
    console.log('ğŸ” DEBUG: Narrative (normalized):', JSON.stringify(cleaned));

    if (cleaned && cleaned.length > 20) return cleaned;

    // Fallback: syntetyczny opis bazujÄ…cy na baseElements (rzadki przypadek)
    const fallback = buildFallbackNarrative(baseElements);
    console.log('ğŸ” DEBUG: Fallback narrative:', JSON.stringify(fallback));
    return fallback;
  } catch (error) {
    console.error('Local LLM error:', error);
    return buildFallbackNarrative(baseElements);
  }
};

// Prosty fallback opisowy
function buildFallbackNarrative(elements: string[]): string {
  const subject = elements.find(e => /woman|man/i.test(e)) || 'person';
  const mood = elements.find(e => /(suggestive|explicit)/i.test(e)) ? 'with a bold, intimate mood' : 'with a calm, reflective mood';
  const style = elements.find(e => /(cinematic|realistic|artistic|photorealistic|professional)/i.test(e)) || 'cinematic';
  return `A ${subject} in a thoughtfully composed scene, ${mood}. Gentle, ${style} lighting shapes the subject while the background falls softly out of focus. The environment adds texture and depth, inviting the viewer into the moment.`;
}

C. Upewnij siÄ™, Å¼e STOP_SEQS sÄ… bez â€œASSISTANT:â€
-------------------------------------------------
W customApiService.ts (i domyÅ›lnie w main.js przez unifyStop) powinno byÄ‡:
  const STOP_SEQS = ['USER:', '\nUSER:', '\n\nUSER:'];

D. (WaÅ¼ne) TheBloke template â€“ trailing space po ASSISTANT:
-----------------------------------------------------------
JeÅ›li jeszcze nie dodaÅ‚eÅ›, zadbaj o spacjÄ™ po â€œASSISTANT:â€ w buildTheBlokePrompt, by model nie â€œkleiÅ‚â€ pierwszego sÅ‚owa.
ZmieÅ„:
  return `${preamble}\n\nUSER: ${userText}\nASSISTANT:`;
Na:
  return `${preamble}\n\nUSER: ${userText}\nASSISTANT: `;

5) Parametry i wskazÃ³wki
- temperature: 0.8â€“0.9 (kreatywnoÅ›Ä‡), top_p: 0.9â€“0.95, maxTokens: 160â€“220 (2â€“3 zdania).
- Nie uÅ¼ywaj normalizeToTagsLine w trybie narracyjnym â€“ tylko normalizeNarrative.
- JeÅ›li model sporadycznie â€œuciekaâ€ do tagÃ³w, w promptach zostaw anty-przykÅ‚ad i â€œReturn only the description; no labels, no parentheses, no quotes.â€
- Debug:
  - Loguj: [PROMPT], [RAW OUT], [Narrative normalized].
  - SprawdÅº dÅ‚ugoÅ›ci przed/po (len > 20 to sensowny prÃ³g minimalny).
  - W main.js nie tnij po â€œASSISTANT:â€, tylko po â€œUSER:â€ (jak juÅ¼ robicie).

6) Opcjonalnie: przeÅ‚Ä…cznik formatÃ³w (â€˜tagsâ€™ | â€˜proseâ€™)
- MoÅ¼esz dodaÄ‡ parametr outputFormat do generateRandomDescription i w zaleÅ¼noÅ›ci od niego:
  - outputFormat === 'tags' â†’ stary prompt + normalizeToTagsLine,
  - outputFormat === 'prose' â†’ nowy prompt + normalizeNarrative.

7) Checklist wdroÅ¼enia
- [ ] System prompt mÃ³wi o prozie (â€œvisual storytellerâ€), nie o tagach.
- [ ] User content: 2â€“3 zdania, zakaz list/etykiet/nawiasÃ³w, przykÅ‚ad bad/good.
- [ ] STOP_SEQS zawiera tylko warianty USER: (bez ASSISTANT:).
- [ ] buildTheBlokePrompt koÅ„czy siÄ™ â€œASSISTANT: â€ (ze spacjÄ…).
- [ ] generateRandomDescription uÅ¼ywa normalizeNarrative (nie normalizeToTagsLine).
- [ ] Fallback tworzy krÃ³tki opis prozÄ…, nie tagi.
- [ ] Logi: raw response + narrative normalized.

8) PrzykÅ‚adowy efekt (oczekiwany)
WejÅ›cie (baseElements): woman, young adult, japanese, curvy build, realistic, cinematic
PrzykÅ‚adowy output:
A young Japanese woman with a curvy build rests on a weathered wooden bench, a quiet confidence in her gaze. Soft, cinematic light brushes her features and spills across the grain of the wood, while the background dissolves into a gentle blur that deepens the intimate mood.

â€” Koniec â€”